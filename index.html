<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Koalitionsrechner ‚Äì Proportionale Sitzverteilung</title>

<!-- Chart.js + Datalabels f√ºr Prognose -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
  :root { --bg:#0b0f14; --card:#121823; --ink:#e8eef7; --muted:#a6b0bf; --ok:#37d07a; --bad:#ff6a6a; --radius:14px; }
  *{box-sizing:border-box}
  body{
    margin:0; padding:32px; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
    background:radial-gradient(1200px 800px at 80% -20%, #1b2b45 0%, #0b0f14 55%);
  }
  h1{margin:0 0 8px; font-size:clamp(20px,2.6vw,32px)}
  p.sub{margin:0 0 24px; color:var(--muted)}
  .wrap{display:grid; gap:16px; grid-template-columns:380px 1fr}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius); padding:16px;
  }
  .row{display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap}
  .row>*{flex:1}
  input,select,button{
    border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:#0f1420; color:var(--ink); padding:10px 12px;
  }
  input[type="color"]{padding:0; height:38px; width:100%}
  button{cursor:pointer; font-weight:600}
  button.secondary{background:#0f1420}

  .party-row{
    display:grid; grid-template-columns:26px 1.3fr .9fr .8fr 1fr 26px;
    gap:8px; align-items:center; margin:8px 0;
  }
  .party-row .handle{opacity:.6; text-align:center; font-size:12px; cursor:grab}
  .party-row.dragging{opacity:.7}
  .party-row .del{opacity:.8; cursor:pointer; text-align:center}

  .legend{display:flex; flex-wrap:wrap; gap:8px}
  .legend .item{
    display:flex; align-items:center; gap:8px; font-size:13px;
    background:#0f1420; border:1px solid rgba(255,255,255,.08);
    padding:6px 10px; border-radius:999px;
  }
  .sw{width:14px; height:14px; border-radius:4px; display:inline-block; border:1px solid rgba(255,255,255,.3)}

  .pill{display:inline-flex; align-items:center; gap:8px; font-size:13px;
        padding:6px 10px; border-radius:999px; background:#0f1420; border:1px solid rgba(255,255,255,.08)}
  .checklist{display:flex; flex-wrap:wrap; gap:10px}
  .checklist label{display:flex; align-items:center; gap:8px;
        border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:999px; background:#0f1420}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  svg{display:block; width:100%; height:auto}

  /* Halbkreis-Animation */
  .arc{opacity:1; transition:opacity .35s ease, transform .35s ease}
  .arc.enter{opacity:0; transform:translate(-18px,22px) scale(0.96)}

  /* Overlay f√ºr Prognose */
  .ard-overlay{position:fixed; inset:0; background:rgba(5,10,20,.6); backdrop-filter:blur(6px);
    display:none; align-items:center; justify-content:center; z-index:9999}
  .ard-panel{width:min(1060px,96vw); max-height:92vh; overflow:auto;
    background:linear-gradient(180deg,#0b1e3a 0%, #0a1730 100%);
    border:1px solid rgba(255,255,255,.12); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.45);
    color:#eaf2ff; padding:18px}
  .ard-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px}
  .ard-title{font-weight:800; letter-spacing:.5px; text-transform:uppercase; font-size:18px}
  .ard-sub{opacity:.8; font-size:12px}
  .ard-progline{height:2px; background:linear-gradient(90deg,#ffe066,#7cc6ff); opacity:.7; margin:6px 0 10px; border-radius:2px}
  .ard-colchart{display:flex; align-items:flex-end; gap:18px; height:360px; background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:20px}
  .ard-foot{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  .ard-btn{border:1px solid rgba(255,255,255,.18); background:#0d2547; color:#eaf2ff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700}
  .ard-btn.secondary{background:#0e1a33}

  /* CDU/CSU-Split-Box */
  .split-box{
    display:none; margin:8px 0 0; padding:10px; border-radius:12px;
    background:#0f1420; border:1px solid rgba(255,255,255,.08);
  }
  .split-box .row{margin:0 0 8px}
  .hint{color:#a6b0bf; font-size:12px}
</style>
</head>
<body>
  <h1>Koalitionsrechner ‚Äì Proportionale Sitzverteilung</h1>
  <p class="sub">Koalitionen testen, Historik 1949‚Äì2025. Prognose-Overlay: ARD-artige S√§ulen (dick, ohne Gitter, Labels oben) ‚Äì pro Klick ein Segment. Optional: CDU/CSU im Overlay √ºbereinander.</p>

  <div class="wrap">
    <!-- Eingaben -->
    <section class="card" id="inputsCard">
      <div class="row">
        <div><label>Gesamtsitze</label><input id="totalSeats" type="number" value="630"></div>
        <div><label>Sperrklausel (%)</label><input id="threshold" type="number" value="5" step="0.1"></div>
      </div>
      <div class="row">
        <div>
          <label>Wahlverfahren</label>
          <select id="method">
            <option value="sls" selected>Sainte-Lagu√´/Schepers</option>
            <option value="dhondt">d‚ÄôHondt</option>
            <option value="hare">Hare-Niemeyer</option>
          </select>
        </div>
        <div><label>Ausnahmen (z. B. SSW)</label><input id="exceptions" placeholder="SSW"></div>
      </div>

      <div class="row" style="justify-content:space-between">
        <button id="addRowBtn" type="button">+ Partei hinzuf√ºgen</button>
        <div style="display:flex; gap:8px">
          <button id="resetBtn" class="secondary" type="button">Zur√ºcksetzen</button>
          <button id="calcBtn" type="button">Neu berechnen</button>
        </div>
      </div>

      <div class="muted" style="margin:6px 0 4px">Parteien & Prozentwerte (Name, % und Farbe frei w√§hlbar)</div>
      <div id="partyList"></div>

      <!-- CDU/CSU Split-Option (nur Overlay) -->
      <div class="split-box" id="splitBox">
        <div class="row" style="align-items:flex-end">
          <label style="flex:2; display:flex; gap:8px; align-items:center">
            <input type="checkbox" id="splitToggle">
            <strong>CDU/CSU trennen (nur Prognose-Overlay)</strong>
          </label>
          <div class="hint" style="flex:3">Sitzverteilung bleibt unver√§ndert zusammengefasst.</div>
        </div>
        <div class="row">
          <div>
            <label>CDU-Anteil (%)</label>
            <input type="number" id="cduPart" step="0.1" min="0" value="22.5">
          </div>
          <div>
            <label>CSU-Anteil (%)</label>
            <input type="number" id="csuPart" step="0.1" min="0" value="6.5">
          </div>
          <div>
            <label>CSU-Farbe (Overlay)</label>
            <input type="color" id="csuColor" value="#b7b7b7">
          </div>
        </div>
        <div class="hint">Summe wird automatisch auf den aktuellen CDU/CSU-Prozentwert normiert.</div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,.08); margin:14px 0">
      <h3 style="margin:4px 0 8px">üï∞Ô∏è Zeitreise ‚Äì historische Ergebnisse</h3>
      <div class="row">
        <div>
          <label>Historische Presets (1949‚Äì2025)</label>
          <select id="historyPreset"></select>
        </div>
        <div>
          <label>Eigenes CSV/JSON</label>
          <input id="historyFile" type="file" accept=".csv,.json">
        </div>
      </div>
      <div class="row">
        <button id="loadPresetBtn" type="button">Preset laden</button>
        <button id="loadFileBtn" class="secondary" type="button">Datei importieren</button>
      </div>
      <p class="sub" style="font-size:12px; margin-top:4px">
        CSV-Format: <code>name,pct,color[,exception]</code> ‚Äì Beispiel: <code>SPD,25.7,#E3000F,true</code>
      </p>
    </section>

    <!-- Visualisierung (Hauptansicht) -->
    <section class="card">
      <svg id="seatChart" viewBox="0 0 900 650" preserveAspectRatio="xMidYMin meet"></svg>
      <div class="legend" id="legend"></div>

      <div class="row" style="margin-top:12px">
        <div class="pill"><strong>Mehrheitsschwelle:</strong> <span id="majorityLbl">316</span></div>
        <div class="pill"><strong>Sitze Koalition:</strong> <span id="coalSeats">0</span></div>
        <div class="pill"><strong>Mehrheit?</strong> <span id="coalMajority" class="bad">nein</span></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Koalitionen testen</h3>
        <div class="checklist" id="coalitionChecklist"></div>
        <div class="row" style="margin-top:8px">
          <label style="flex:1">Vordefinierte Koalition</label>
          <select id="presetCoalition" style="flex:2">
            <option value="">‚Äì ausw√§hlen ‚Äì</option>
            <option value="Schwarz-Rot (Groko)">Schwarz-Rot (Groko)</option>
            <option value="Schwarz-Gr√ºn">Schwarz-Gr√ºn</option>
            <option value="Schwarz-Gelb">Schwarz-Gelb</option>
            <option value="Jamaika-Koalition">Jamaika-Koalition</option>
            <option value="Deutschland-Koalition">Deutschland-Koalition</option>
            <option value="Ampel-Koalition">Ampel-Koalition</option>
            <option value="Kenia-Koalition">Kenia-Koalition</option>
            <option value="Brombeer-Koalition">Brombeer-Koalition</option>
            <option value="Rot-Rot-Gr√ºn">Rot-Rot-Gr√ºn</option>
            <option value="Rot-Gr√ºn-Rot">Rot-Gr√ºn-Rot</option>
            <option value="Gr√ºn-Rot-Rot">Gr√ºn-Rot-Rot</option>
            <option value="SPD-BSW">SPD-BSW</option>
            <option value="Rot-Gr√ºn">Rot-Gr√ºn</option>
            <option value="Sozialliberale Koalition">Sozialliberale Koalition</option>
            <option value="Gr√ºn-Liberale Koalition">Gr√ºn-Liberale Koalition</option>
            <option value="Rot-Rote Koalition">Rot-Rote Koalition</option>
          </select>
        </div>
        <div class="row">
          <button id="showArdBtn" type="button">ARD-Prognose starten</button>
        </div>
      </div>
    </section>
  </div>

<!-- ===== Datens√§tze 1949‚Äì2025 (kompakt) ===== -->
<script id="HIST_DATA" type="application/json">
{
  "1949":[{"name":"CDU/CSU","pct":31.0,"color":"#000000"},{"name":"SPD","pct":29.2,"color":"#E3000F"},{"name":"FDP","pct":11.9,"color":"#FFED00"},{"name":"KPD","pct":5.7,"color":"#BF0000"},{"name":"BP","pct":4.2,"color":"#888888"},{"name":"DP","pct":4.0,"color":"#888888"},{"name":"Zentrum","pct":3.1,"color":"#999999"},{"name":"WAV","pct":2.9,"color":"#999999"}],
  "1953":[{"name":"CDU/CSU","pct":45.2,"color":"#000000"},{"name":"SPD","pct":28.8,"color":"#E3000F"},{"name":"FDP","pct":9.5,"color":"#FFED00"},{"name":"GB/BHE","pct":5.9,"color":"#999999"},{"name":"DP","pct":3.3,"color":"#999999"},{"name":"BP","pct":3.1,"color":"#888888"}],
  "1957":[{"name":"CDU/CSU","pct":50.2,"color":"#000000"},{"name":"SPD","pct":31.8,"color":"#E3000F"},{"name":"FDP","pct":7.7,"color":"#FFED00"}],
  "1961":[{"name":"CDU/CSU","pct":45.3,"color":"#000000"},{"name":"SPD","pct":36.2,"color":"#E3000F"},{"name":"FDP","pct":12.8,"color":"#FFED00"}],
  "1965":[{"name":"CDU/CSU","pct":47.6,"color":"#000000"},{"name":"SPD","pct":39.3,"color":"#E3000F"},{"name":"FDP","pct":9.5,"color":"#FFED00"},{"name":"NPD","pct":2.0,"color":"#777777"}],
  "1969":[{"name":"CDU/CSU","pct":46.1,"color":"#000000"},{"name":"SPD","pct":42.7,"color":"#E3000F"},{"name":"FDP","pct":5.8,"color":"#FFED00"},{"name":"NPD","pct":4.3,"color":"#777777"}],
  "1972":[{"name":"SPD","pct":45.8,"color":"#E3000F"},{"name":"CDU/CSU","pct":44.9,"color":"#000000"},{"name":"FDP","pct":8.4,"color":"#FFED00"}],
  "1976":[{"name":"CDU/CSU","pct":48.6,"color":"#000000"},{"name":"SPD","pct":42.6,"color":"#E3000F"},{"name":"FDP","pct":7.9,"color":"#FFED00"}],
  "1980":[{"name":"CDU/CSU","pct":44.5,"color":"#000000"},{"name":"SPD","pct":42.9,"color":"#E3000F"},{"name":"FDP","pct":10.6,"color":"#FFED00"}],
  "1983":[{"name":"CDU/CSU","pct":48.8,"color":"#000000"},{"name":"SPD","pct":38.2,"color":"#E3000F"},{"name":"FDP","pct":7.0,"color":"#FFED00"},{"name":"Gr√ºne","pct":5.6,"color":"#1FA12E"}],
  "1987":[{"name":"CDU/CSU","pct":44.3,"color":"#000000"},{"name":"SPD","pct":37.0,"color":"#E3000F"},{"name":"FDP","pct":9.1,"color":"#FFED00"},{"name":"Gr√ºne","pct":8.3,"color":"#1FA12E"}],
  "1990":[{"name":"CDU/CSU","pct":43.8,"color":"#000000"},{"name":"SPD","pct":33.5,"color":"#E3000F"},{"name":"FDP","pct":11.0,"color":"#FFED00"},{"name":"Gr√ºne/B90","pct":5.1,"color":"#1FA12E"},{"name":"PDS","pct":2.4,"color":"#BE3075"},{"name":"REP","pct":2.1,"color":"#777777"}],
  "1994":[{"name":"CDU/CSU","pct":41.4,"color":"#000000"},{"name":"SPD","pct":36.4,"color":"#E3000F"},{"name":"FDP","pct":6.9,"color":"#FFED00"},{"name":"Gr√ºne/B90","pct":7.3,"color":"#1FA12E"},{"name":"PDS","pct":4.4,"color":"#BE3075"}],
  "1998":[{"name":"SPD","pct":40.9,"color":"#E3000F"},{"name":"CDU/CSU","pct":35.1,"color":"#000000"},{"name":"FDP","pct":6.2,"color":"#FFED00"},{"name":"Gr√ºne/B90","pct":6.7,"color":"#1FA12E"},{"name":"PDS","pct":5.1,"color":"#BE3075"}],
  "2002":[{"name":"SPD","pct":38.5,"color":"#E3000F"},{"name":"CDU/CSU","pct":38.5,"color":"#000000"},{"name":"FDP","pct":7.4,"color":"#FFED00"},{"name":"Gr√ºne/B90","pct":8.6,"color":"#1FA12E"},{"name":"PDS","pct":4.0,"color":"#BE3075"}],
  "2005":[{"name":"CDU/CSU","pct":35.2,"color":"#000000"},{"name":"SPD","pct":34.2,"color":"#E3000F"},{"name":"FDP","pct":9.8,"color":"#FFED00"},{"name":"Gr√ºne/B90","pct":8.1,"color":"#1FA12E"},{"name":"Linke/PDS","pct":8.7,"color":"#BE3075"}],
  "2009":[{"name":"CDU/CSU","pct":33.8,"color":"#000000"},{"name":"SPD","pct":23.0,"color":"#E3000F"},{"name":"FDP","pct":14.6,"color":"#FFED00"},{"name":"Gr√ºne/B90","pct":10.7,"color":"#1FA12E"},{"name":"Linke","pct":11.9,"color":"#BE3075"}],
  "2013":[{"name":"CDU/CSU","pct":41.5,"color":"#000000"},{"name":"SPD","pct":25.7,"color":"#E3000F"},{"name":"Gr√ºne/B90","pct":8.4,"color":"#1FA12E"},{"name":"Linke","pct":8.6,"color":"#BE3075"},{"name":"AfD","pct":4.7,"color":"#009EE0"}],
  "2017":[{"name":"CDU/CSU","pct":32.9,"color":"#000000"},{"name":"SPD","pct":20.5,"color":"#E3000F"},{"name":"FDP","pct":10.7,"color":"#FFED00"},{"name":"Gr√ºne/B90","pct":8.9,"color":"#1FA12E"},{"name":"Linke","pct":9.2,"color":"#BE3075"},{"name":"AfD","pct":12.6,"color":"#009EE0"}],
  "2021":[{"name":"SPD","pct":25.7,"color":"#E3000F"},{"name":"CDU/CSU","pct":24.1,"color":"#000000"},{"name":"Gr√ºne/B90","pct":14.8,"color":"#1FA12E"},{"name":"FDP","pct":11.5,"color":"#FFED00"},{"name":"AfD","pct":10.3,"color":"#009EE0"},{"name":"Linke","pct":4.9,"color":"#BE3075","exception":true}],
  "2025":[{"name":"CDU/CSU","pct":28.6,"color":"#000000"},{"name":"SPD","pct":16.4,"color":"#E3000F"},{"name":"FDP","pct":4.3,"color":"#FFED00"},{"name":"Gr√ºne/B90","pct":11.6,"color":"#1FA12E"},{"name":"Linke","pct":8.8,"color":"#BE3075"},{"name":"AfD","pct":20.8,"color":"#009EE0"},{"name":"SSW","pct":0.2,"color":"#66CCFF","exception":true}]
}
</script>

<script>
/* ----- Polyfill: CSS.escape (Safari/iOS) ----- */
if (!window.CSS || typeof CSS.escape !== "function") {
  window.CSS = window.CSS || {};
  CSS.escape = function (value) {
    return String(value)
      .replace(/[\0-\x1F\x7F]/g, "\uFFFD")
      .replace(/^[0-9-]/, '\\$&')
      .replace(/[^a-zA-Z0-9_\u00A0-\uFFFF-]/g, '\\$&');
  };
}

/* Koalitions-Presets */
const PRESETS = {
  "Schwarz-Rot (Groko)":     ["CDU/CSU","SPD"],
  "Schwarz-Gr√ºn":            ["CDU/CSU","Gr√ºne","Gr√ºne/B90"],
  "Schwarz-Gelb":            ["CDU/CSU","FDP"],
  "Jamaika-Koalition":       ["CDU/CSU","FDP","Gr√ºne","Gr√ºne/B90"],
  "Deutschland-Koalition":   ["CDU/CSU","SPD","FDP"],
  "Ampel-Koalition":         ["SPD","Gr√ºne","Gr√ºne/B90","FDP"],
  "Kenia-Koalition":         ["CDU/CSU","SPD","Gr√ºne","Gr√ºne/B90"],
  "Brombeer-Koalition":      ["SPD","Linke","BSW"],
  "Rot-Rot-Gr√ºn":            ["SPD","Linke","Gr√ºne","Gr√ºne/B90"],
  "Rot-Gr√ºn-Rot":            ["SPD","Linke","Gr√ºne","Gr√ºne/B90"],
  "Gr√ºn-Rot-Rot":            ["SPD","Linke","Gr√ºne","Gr√ºne/B90"],
  "SPD-BSW":                 ["SPD","BSW"],
  "Rot-Gr√ºn":                ["SPD","Gr√ºne","Gr√ºne/B90"],
  "Sozialliberale Koalition":["SPD","FDP"],
  "Gr√ºn-Liberale Koalition": ["Gr√ºne","Gr√ºne/B90","FDP"],
  "Rot-Rote Koalition":      ["SPD","Linke"]
};

/* Helpers & State */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
let selectedCoalition = new Set();
const GREY = "#b7bdc7";
const norm = n => (n||"").toString().trim().toLowerCase().replace(/\s+/g,"");
const isOther = name => { const n=norm(name); return n==="andere" || n==="sonstige"; };

/* Defaults */
const defaultParties = [
  {name:"CDU/CSU", color:"#000000", pct:28},
  {name:"SPD",     color:"#E3000F", pct:17},
  {name:"Gr√ºne",   color:"#1FA12E", pct:12},
  {name:"FDP",     color:"#FFED00", pct:6},
  {name:"AfD",     color:"#009EE0", pct:20},
  {name:"Linke",   color:"#BE3075", pct:6},
  {name:"BSW",     color:"#FF6A00", pct:7}
];

/* UI */
function addPartyRow(p = {name:"Neue Partei", color:"#8888ff", pct:0, exception:false}){
  const row=document.createElement("div");
  row.className="party-row";
  row.innerHTML=`
    <div class="handle">‚ãÆ‚ãÆ</div>
    <input class="pName" type="text" value="${p.name}">
    <input class="pPct" type="number" value="${p.pct}" min="0" max="100" step="0.1">
    <input class="pColor" type="color" value="${p.color}">
    <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#a6b0bf">
      <input type="checkbox" class="pExc" ${p.exception?"checked":""}> Ausnahme
    </label>
    <div class="del" title="Entfernen">‚úï</div>`;
  row.querySelector(".del").onclick=()=>{ row.remove(); calcAndRender(); maybeShowSplitBox(); };
  $("#partyList").appendChild(row);
  setupRowDnD(row);
  row.querySelectorAll("input").forEach(inp=>inp.addEventListener("change", ()=>{ calcAndRender(); maybeShowSplitBox(); }));
}
function setPartyList(list){ $("#partyList").innerHTML=""; list.forEach(addPartyRow); }
function setDefaults(){ setPartyList(defaultParties); selectedCoalition = new Set(); calcAndRender(); maybeShowSplitBox(); }

/* ---- Drag & Drop Reordering ---- */
function setupRowDnD(row){
  row.setAttribute('draggable','true');
  row.addEventListener('dragstart', onDragStart);
  row.addEventListener('dragend', onDragEnd);
}
function onDragStart(e){
  const row = e.currentTarget;
  row.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  try { e.dataTransfer.setData('text/plain','party-row'); } catch(_) {}
  const container = document.getElementById('partyList');
  container.addEventListener('dragover', onDragOver);
  container.addEventListener('drop', onDrop);
}
function onDragEnd(e){
  const row = e.currentTarget;
  row.classList.remove('dragging');
  const container = document.getElementById('partyList');
  container.removeEventListener('dragover', onDragOver);
  container.removeEventListener('drop', onDrop);
  calcAndRender(); maybeShowSplitBox();
}
function onDragOver(e){
  e.preventDefault();
  const container = e.currentTarget;
  const dragging = container.querySelector('.party-row.dragging');
  if(!dragging) return;
  const after = getRowAfter(container, e.clientY);
  if (after == null) container.appendChild(dragging);
  else container.insertBefore(dragging, after);
}
function onDrop(e){ e.preventDefault(); }
function getRowAfter(container, mouseY){
  const rows = [...container.querySelectorAll('.party-row:not(.dragging)')];
  let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
  rows.forEach(r=>{
    const box = r.getBoundingClientRect();
    const offset = mouseY - (box.top + box.height/2);
    if (offset < 0 && offset > closest.offset){ closest = {offset, element:r}; }
  });
  return closest.element;
}

/* Verfahren */
function filterByThreshold(parties, threshold, exceptions){
  return parties.filter(p =>
    !isOther(p.name) &&
    p.pct > 0 &&
    (p.pct >= threshold || p.exception || (exceptions||[]).includes(p.name))
  );
}
function sls(parties,seats){
  const Q=[]; parties.forEach((p,i)=>{const v=p.pct*1e6; for(let k=0;k<seats+5;k++) Q.push({i,val:v/(k+0.5)})});
  Q.sort((a,b)=>b.val-a.val); const c=new Array(parties.length).fill(0);
  Q.slice(0,seats).forEach(q=>c[q.i]++); return c;
}
function dhondt(parties,seats){
  const Q=[]; parties.forEach((p,i)=>{const v=p.pct*1e6; for(let k=1;k<=seats;k++) Q.push({i,val:v/k})});
  Q.sort((a,b)=>b.val-a.val); const c=new Array(parties.length).fill(0);
  Q.slice(0,seats).forEach(q=>c[q.i]++); return c;
}
function hareNiemeyer(parties,seats){
  const votes=parties.map(p=>p.pct), total=votes.reduce((a,b)=>a+b,0);
  if(total===0) return new Array(parties.length).fill(0);
  const quotas=votes.map(v=>v/total*seats), base=quotas.map(q=>Math.floor(q));
  let assigned=base.reduce((a,b)=>a+b,0);
  const rem=quotas.map((q,i)=>({i,r:q-Math.floor(q)})).sort((a,b)=>b.r-a.r);
  for(let k=0; assigned<seats && k<rem.length; k++){ base[rem[k].i]++; assigned++; }
  return base;
}
function allocateSeats(p,s,m){ if(m==="dhondt") return dhondt(p,s); if(m==="hare") return hareNiemeyer(p,s); return sls(p,s); }

function computeSeats(parties,seats,threshold,exceptions,method){
  const clean = parties.map(p => isOther(p.name)?{...p,pct:0}:p);
  const ok = filterByThreshold(clean, threshold, exceptions);
  const result = clean.map(p=>({...p,seats:0}));
  if(ok.length){
    const counts = allocateSeats(ok, seats, method);
    ok.forEach((p,i)=>{ const j=result.findIndex(q=>q.name===p.name); if(j>=0) result[j].seats = counts[i]; });
  }
  result.forEach(p=>{ if(isOther(p.name)) p.seats=0; });
  return result;
}

/* Zeichnen & Layout */
function layoutArcs(data,total,sel){
  const coal = data.filter(p=>p.seats>0 && sel.has(p.name));
  const rest = data.filter(p=>p.seats>0 && !sel.has(p.name));
  const ordered = [...coal, ...rest];
  const sum = ordered.reduce((a,b)=>a+b.seats,0) || total;
  let start = Math.PI;
  return ordered.map(p=>{
    const sweep = (p.seats/sum)*Math.PI;
    const arc = {name:p.name, fill: sel.has(p.name)?p.color:GREY, start, end:start+sweep};
    start += sweep;
    return arc;
  });
}
function arcD(r1,r2,a0,a1){
  const large=(a1-a0)>Math.PI?1:0;
  const x0=r1*Math.cos(a0), y0=r1*Math.sin(a0);
  const x1=r1*Math.cos(a1), y1=r1*Math.sin(a1);
  const x1i=r2*Math.cos(a1), y1i=r2*Math.sin(a1);
  const x0i=r2*Math.cos(a0), y0i=r2*Math.sin(a0);
  return `M${x0} ${y0}A${r1} ${r1} 0 ${large} 1 ${x1} ${y1}L${x1i} ${y1i}A${r2} ${r2} 0 ${large} 0 ${x0i} ${y0i}Z`;
}
function drawHalfRing(svg,data,total,sel){
  const w=900,h=650,cx=w/2,cy=h*0.86;
  const ringWidth=180, rO=280, rI=rO-ringWidth;
  svg.innerHTML="";
  svg.setAttribute("viewBox","0 0 900 650");
  svg.setAttribute("preserveAspectRatio","xMidYMin meet");

  const g=document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("class","seats");
  g.setAttribute("transform",`translate(${cx},${cy})`);
  svg.appendChild(g);

  const arcs=layoutArcs(data,total,sel||new Set());
  arcs.forEach(a=>{
    const path=document.createElementNS("http://www.w3.org/2000/svg","path");
    path.dataset.name=a.name;
    path.setAttribute("class","arc enter");
    path.setAttribute("fill",a.fill);
    path.setAttribute("stroke","rgba(255,255,255,.12)");
    path.setAttribute("stroke-width","1");
    path.setAttribute("d", arcD(rO,rI,a.start,a.end));
    g.appendChild(path);
    requestAnimationFrame(()=> path.classList.remove("enter"));
  });

  $("#majorityLbl").textContent = (Math.floor(total/2)+1).toString();
}

/* Legend & Koalitionen-UI */
function renderLegend(d){
  const el=$("#legend"); el.innerHTML="";
  d.filter(p=>p.seats>0 && !isOther(p.name)).forEach(p=>{
    const n=document.createElement("div"); n.className="item";
    n.innerHTML=`<span class="sw" style="background:${p.color}"></span><strong>${p.name}</strong> ‚Äì ${p.seats} Sitze`;
    el.appendChild(n);
  });
}
function renderChecklist(d){
  const wrap=$("#coalitionChecklist"); wrap.innerHTML="";
  const shown = d.filter(p=>p.seats>0 && !isOther(p.name)).map(p=>p.name);
  selectedCoalition = new Set([...selectedCoalition].filter(n=>shown.includes(n)));
  d.filter(p=>p.seats>0 && !isOther(p.name)).forEach(p=>{
    const lab=document.createElement("label");
    lab.innerHTML=`<input type="checkbox" data-name="${p.name}" ${selectedCoalition.has(p.name)?"checked":""}>
                   <span class="sw" style="background:${p.color}"></span> ${p.name} (${p.seats})`;
    wrap.appendChild(lab);
  });
  wrap.querySelectorAll("input[type=checkbox]").forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const n=cb.dataset.name;
      if(cb.checked) selectedCoalition.add(n); else selectedCoalition.delete(n);
      calcAndRender();
    });
  });
}

/* Koalitionssumme */
function recomputeCoalitionSum(){
  const totalSeats = parseInt($("#totalSeats").value)||0;
  const majority   = Math.floor(totalSeats/2)+1;
  const data       = window.__lastSeats||[];
  const sum = data.reduce((a,p)=>a+(selectedCoalition.has(p.name)?(p.seats||0):0),0);
  $("#coalSeats").textContent = sum;
  const ok = sum>=majority;
  $("#coalMajority").textContent = ok ? "ja" : "nein";
  $("#coalMajority").className   = ok ? "ok" : "bad";
}

/* History */
function getHistData(){ try{ return JSON.parse(document.getElementById("HIST_DATA").textContent); }catch(e){ return {}; } }
function fillHistoryDropdown(){
  const hist = getHistData();
  const sel = $("#historyPreset");
  sel.innerHTML = '<option value="">‚Äì w√§hlen ‚Äì</option>' +
    Object.keys(hist).sort().map(y=>`<option value="${y}">${y}</option>`).join('');
}
function applyHistory(year){
  const hist=getHistData(); const list=hist[year]; if(!list) return;
  setPartyList(list); selectedCoalition = new Set(); calcAndRender(); maybeShowSplitBox();
}
function parseCSV(text){
  const rows=text.trim().split(/\r?\n/);
  return rows.map(r=>{
    const [name,pct,color,exc] = r.split(",").map(s=>s.trim());
    return {name, pct:parseFloat(pct)||0, color:color||"#8888ff", exception: String(exc||"").toLowerCase()==="true"};
  });
}

/* Haupt-Loop */
function readInputs(){
  const partyRows=$$("#partyList .party-row");
  const parties=partyRows.map(r=>({
    name:(r.querySelector(".pName").value||"").trim(),
    color:r.querySelector(".pColor").value,
    pct:parseFloat(r.querySelector(".pPct").value)||0,
    exception:r.querySelector(".pExc")?.checked||false
  }));
  return {
    totalSeats: parseInt($("#totalSeats").value)||0,
    threshold:  parseFloat($("#threshold").value)||0,
    method:     $("#method").value,
    exceptions: ($("#exceptions").value||"").split(",").map(s=>s.trim()).filter(Boolean),
    parties
  };
}
function computeAndOrder(parties,totalSeats,threshold,exceptions,method){
  const seatsData = computeSeats(parties,totalSeats,threshold,exceptions,method);
  const shown = seatsData.filter(p => (!isOther(p.name)) && (p.pct >= 2 || (p.seats||0)>0));
  return shown;
}
function calcAndRender(){
  const {totalSeats,threshold,method,exceptions,parties}=readInputs();
  const shown = computeAndOrder(parties,totalSeats,threshold,exceptions,method);
  window.__lastSeats = shown;
  drawHalfRing($("#seatChart"), shown, totalSeats, selectedCoalition);
  renderLegend(shown);
  renderChecklist(shown);
  $("#majorityLbl").textContent = (Math.floor(totalSeats/2)+1).toString();
  recomputeCoalitionSum();
}

/* CDU/CSU-Split UI Sichtbarkeit + Logik */
function maybeShowSplitBox(){
  const names = $$("#partyList .pName").map(i=>i.value.trim());
  const hasUnion = names.includes("CDU/CSU");
  const box = $("#splitBox");
  box.style.display = hasUnion ? "block" : "none";
  normalizeSplitToUnionValue();
}
function getUnionPct(){
  const rows = $$("#partyList .party-row");
  for(const r of rows){
    const n = r.querySelector(".pName").value.trim();
    if(n==="CDU/CSU"){ return parseFloat(r.querySelector(".pPct").value)||0; }
  }
  return 0;
}
function normalizeSplitToUnionValue(){
  const union = getUnionPct();
  const cdu = parseFloat($("#cduPart").value)||0;
  const csu = parseFloat($("#csuPart").value)||0;
  const sum = Math.max(0, cdu+csu);
  if(sum<=0){ $("#cduPart").value = union; $("#csuPart").value = 0; return; }
  const f = union / sum;
  $("#cduPart").value = (cdu*f).toFixed(1);
  $("#csuPart").value = (csu*f).toFixed(1);
}
$("#splitToggle").addEventListener("change", ()=> normalizeSplitToUnionValue());
$("#cduPart").addEventListener("input", ()=>{
  const union = getUnionPct(); const cdu = Math.max(0, parseFloat($("#cduPart").value)||0);
  $("#csuPart").value = Math.max(0, (union - cdu)).toFixed(1);
});
$("#csuPart").addEventListener("input", ()=>{
  const union = getUnionPct(); const csu = Math.max(0, parseFloat($("#csuPart").value)||0);
  $("#cduPart").value = Math.max(0, (union - csu)).toFixed(1);
});

/* Events */
$("#addRowBtn").addEventListener("click", ()=>{ addPartyRow(); calcAndRender(); maybeShowSplitBox(); });
$("#resetBtn").addEventListener("click", ()=>{ setDefaults(); $("#splitToggle").checked=false; });
$("#calcBtn").addEventListener("click", ()=>{ calcAndRender(); normalizeSplitToUnionValue(); });
$("#totalSeats").addEventListener("change", calcAndRender);
$("#threshold").addEventListener("change", calcAndRender);
$("#method").addEventListener("change", calcAndRender);
$("#exceptions").addEventListener("change", calcAndRender);

// Koalitions-Preset
$("#presetCoalition").addEventListener("change", ()=>{
  const key = $("#presetCoalition").value;
  selectedCoalition = key ? new Set(PRESETS[key] || []) : new Set();
  calcAndRender();
});

// History
fillHistoryDropdown();
$("#loadPresetBtn").addEventListener("click", ()=>{
  const y = $("#historyPreset").value; if(!y) return;
  applyHistory(y);
});
$("#loadFileBtn").addEventListener("click", async ()=>{
  const f = $("#historyFile").files[0]; if(!f) return;
  const txt = await f.text();
  let list = [];
  try{
    if(f.name.endsWith(".json")) list = JSON.parse(txt);
    else list = parseCSV(txt);
  }catch(e){ alert("Datei konnte nicht gelesen werden."); return; }
  setPartyList(list); selectedCoalition=new Set(); calcAndRender(); maybeShowSplitBox();
});

/* Init */
setDefaults();
</script>

<!-- ===== ARD-Prognose OVERLAY ‚Äì pro Klick animiert; optional CDU/CSU gestapelt ===== -->
<div id="forecastOverlay" class="ard-overlay">
  <div class="ard-panel">
    <div class="ard-head">
      <div>
        <div class="ard-title">Prognose ‚Äì ARD-Stil (inoffiziell)</div>
        <div class="ard-sub">Basis: aktuelle Eingaben. Pro Klick f√§hrt genau ein Segment hoch. Optional: CDU/CSU als Stapel.</div>
      </div>
      <button class="ard-btn" id="closeForecast">Schlie√üen</button>
    </div>

    <div class="ard-progline"></div>

    <div class="ard-colchart">
      <canvas id="forecastChart" width="1000" height="360"></canvas>
    </div>

    <div class="ard-foot">
      <button class="ard-btn secondary" id="resetBars">‚ü≤ Reset</button>
      <button class="ard-btn" id="nextBarBtn">N√§chstes Segment animieren</button>
    </div>
  </div>
</div>

<script>
/* ===== Prognose-Overlay (Chart.js) ‚Äì S√§ulen/Segmente wachsen pro Klick ===== */
let forecastChart = null;
let stepIndex = 0;            // l√§uft √ºber Segmente, nicht nur Parteien
let segments = [];            // Liste der zu animierenden Schritte
let labelsOrder = [];         // Reihenfolge der Kategorien (wie Eingabe)
let baseColors = [];          // Farben pro Kategorie (unteres Dataset)
let overlayColors = [];       // Farben f√ºr das obere (nur CSU, sonst transparent)

const commaDe = x => Number(x||0).toFixed(1).replace(".", ",");

// √ñffnen
document.getElementById("showArdBtn").addEventListener("click", ()=>{
  buildForecastData();        // Eingabereihenfolge, evtl. mit CSU-Kappe
  openForecast();
});
document.getElementById("closeForecast").addEventListener("click", ()=> {
  document.getElementById("forecastOverlay").style.display="none";
});
document.getElementById("resetBars").addEventListener("click", resetForecast);
document.getElementById("nextBarBtn").addEventListener("click", animateNextSegment);
document.getElementById("forecastChart").addEventListener("click", animateNextSegment);

// Daten aus aktuellen Eingaben holen ‚Äì **Eingabereihenfolge**
function buildForecastData(){
  const inp = readInputs();
  const splitOn = $("#splitToggle").checked;
  const csuHex  = $("#csuColor").value || "#b7b7b7";
  const cduPct  = parseFloat($("#cduPart").value)||0;
  const csuPct  = parseFloat($("#csuPart").value)||0;

  // Kategorien in genau der Reihenfolge der Eingabeliste
  labelsOrder = [];
  baseColors  = [];
  overlayColors = [];
  const baseData = [];        // unterer Stack (alle Parteien, bei Union = CDU-Anteil)
  const topData  = [];        // oberer Stack (nur CSU an Union-Position; sonst 0)

  inp.parties.forEach(p=>{
    if(!p || !p.name || isOther(p.name)) return;
    labelsOrder.push(p.name);
    if(splitOn && p.name==="CDU/CSU"){
      baseData.push(Math.max(0, cduPct));
      topData.push(Math.max(0, csuPct));
      baseColors.push(p.color);     // CDU nutzt die aktuell eingestellte Unionsfarbe
      overlayColors.push(csuHex);   // CSU eigene Farbe (Overlay)
    }else{
      baseData.push(Math.max(0, p.pct||0));
      topData.push(0);
      baseColors.push(p.color);
      overlayColors.push("transparent");
    }
  });

  // Aus baseData/topData generieren wir die Animations-Schritte in Reihenfolge:
  // f√ºr jede Kategorie: zuerst base (falls >0), ggf. danach top (falls >0)
  segments = [];
  for(let i=0;i<labelsOrder.length;i++){
    const b = baseData[i], t = topData[i];
    if(b>0) segments.push({dataset:0, index:i, target:b});
    if(t>0) segments.push({dataset:1, index:i, target:t});
  }

  // Chart (neu) initialisieren
  initForecastChart(baseData, topData);
}

// Overlay √∂ffnen
function openForecast(){
  const ov = document.getElementById("forecastOverlay");
  ov.style.display = "flex";
  resetForecast();
}

// Chart aufsetzen: dicke Balken, KEINE R√§nder, KEINE Grid-Linien, Labels oben drau√üen, Namen wei√ü
function initForecastChart(baseData, topData){
  const ctx = document.getElementById("forecastChart");
  if (forecastChart) { forecastChart.destroy(); }

  forecastChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labelsOrder,
      datasets: [
        { // Untere Ebene (alle Parteien bzw. CDU bei Union)
          label: "Prognose",
          data: baseData.map(()=>0),           // starten bei 0, animieren manuell
          backgroundColor: baseColors,
          borderColor: "transparent",
          borderWidth: 0,
          borderSkipped: false,
          barThickness: 72,                    // dicke Balken
          maxBarThickness: 84,
          categoryPercentage: 0.66,
          barPercentage: 0.90,
          stack: "x"
        },
        { // Obere Ebene (nur CSU als Kappe, sonst 0)
          label: "CSU",
          data: topData.map(()=>0),
          backgroundColor: overlayColors,
          borderColor: "transparent",
          borderWidth: 0,
          borderSkipped: false,
          barThickness: 72,
          maxBarThickness: 84,
          categoryPercentage: 0.66,
          barPercentage: 0.90,
          stack: "x"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,               // wir animieren manuell
      plugins: {
        legend: { display: false },
        datalabels: {
          color: "#ffffff",
          anchor: "end",              // an der Oberkante
          align: "end",               // au√üerhalb oberhalb
          offset: 8,
          clip: false,
          font: { weight: "bold", size: 16 },
          formatter: (value) => value > 0 ? commaDe(value) + " %" : ""
        }
      },
      scales: {
        x: {
          stacked: true,
          grid: { display: false },          // KEINE Linien
          ticks: { color: "#ffffff", font: { weight: "bold", size: 14 } }
        },
        y: {
          stacked: true,
          beginAtZero: true,
          suggestedMax: Math.max(
            30,
            Math.ceil(
              Math.max(
                ...labelsOrder.map((_,i)=> (forecastChart ? 0 : 0)) // placeholder, ersetzt unten beim Reset
              ) + 5
            )
          ),
          grid: { display: false },          // KEINE Linien
          ticks: { color:"#ffffff", font:{ size: 12 }, callback: v => v + "%" }
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  // suggestedMax sauber setzen: basierend auf Zielwerten
  const targetsMax = Math.max(30, Math.ceil(calcMaxTotal(baseData, topData) + 5));
  forecastChart.options.scales.y.suggestedMax = targetsMax;
}

// Hilfsfunktion: maximaler gestapelter Wert
function calcMaxTotal(baseData, topData){
  let m = 0;
  for(let i=0;i<baseData.length;i++){
    m = Math.max(m, (baseData[i]||0) + (topData[i]||0));
  }
  return m;
}

// Reset: alle Segmente auf 0
function resetForecast(){
  stepIndex = 0;
  forecastChart.data.datasets.forEach(ds => ds.data = ds.data.map(()=>0));
  forecastChart.update();
}

// Pro Klick f√§hrt das **n√§chste Segment** hoch
function animateNextSegment(){
  if (!forecastChart) return;
  if (stepIndex >= segments.length) return;

  const seg = segments[stepIndex];
  const {dataset, index, target} = seg;

  let step = 0;
  const steps = 30;        // 30 Frames
  const timer = setInterval(()=>{
    step++;
    const cur = target * (step/steps);
    forecastChart.data.datasets[dataset].data[index] = cur;
    forecastChart.update();
    if (step >= steps){
      forecastChart.data.datasets[dataset].data[index] = target;
      forecastChart.update();
      clearInterval(timer);
      stepIndex++;
    }
  }, 40); // 40ms ‚Üí ~1.2s pro Segment
}
</script>

<!-- Quellenhinweis (optional)
  Basisdaten: Deutscher Bundestag ‚Äì ‚ÄûBundestagswahlergebnisse seit 1949 ‚Äì Zweitstimmen‚Äú.
  Erg√§nzungen >2% (z. B. NPD 1969, REP 1990) aus Material der Bundeswahlleiterin.
-->
</body>
</html>
